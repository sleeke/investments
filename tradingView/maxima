// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© BritishBritishColumbian


//@version=4
study("Local Maxima")


// -------//
// Inputs //
// -------//

// The number of sessions to use for the maxima/minima
studyRange = input(       
     title="Number of sessions either side of local maxima/minima", 
     type=input.integer, 
     defval=1, 
     minval=1, 
     maxval=10)

requiredDeltaPercent = input(       
     title="percent change required for local maxima/minima", 
     type=input.float, 
     defval=1, 
     minval=0, 
     maxval=10)


// ---------------------------//
// Maxima/minima calculation //
// ---------------------------//

varip maximaHistory = array.new_float(2, 0.0)
varip minimaHistory = array.new_float(2, 0.0)

minimaStudyPeriod = array.new_float()
maximaStudyPeriod = array.new_float()
for i = 0 to studyRange * 2 + 1
	array.push(minimaStudyPeriod, low[i])
	array.push(maximaStudyPeriod, high[i])


localMinima = array.min(minimaStudyPeriod)
localMaxima = array.max(maximaStudyPeriod)
deltaPercent = abs(localMaxima / localMinima - 1) * 100

if (array.get(maximaStudyPeriod, studyRange) >= localMaxima and deltaPercent > requiredDeltaPercent)
    array.shift(maximaHistory)
    array.push(maximaHistory, localMaxima)
    // array.shift(minimaHistory)
    // array.push(minimaHistory, 0.0)
    

if (array.get(minimaStudyPeriod, studyRange) <= localMinima and deltaPercent > requiredDeltaPercent)
    array.shift(minimaHistory)
    array.push(minimaHistory, localMinima)
    // array.shift(maximaHistory)
    // array.push(maximaHistory, 0.0)


// --------------//
// Study outputs //
// --------------//

// Plot colors
tttr = input(#51B561, "Maxima delta", input.color)
positiveColor = color.new(positiveColorInput, 30)
positiveFadedColor = color.new(positiveColor, 70)
negativeColorInput = input(#FA4040, "Minima delta", input.color)
negativeColor = color.new(negativeColorInput, 50)
negativeFadedColor = color.new(negativeColor, 80)

priceAboveLastMinima = close - array.get(minimaHistory, 1)
priceAboveLastMaxima = close - array.get(maximaHistory, 1)

minimaDiff = array.get(minimaHistory, 1) / array.get(minimaHistory, 0) - 1
maximaDiff = array.get(maximaHistory, 1) / array.get(maximaHistory, 0) - 1

exitSignal = 0.0
if maximaDiff < 0 and priceAboveLastMaxima < 0 
    exitSignal := -1//abs(maximaDiff)
    
if priceAboveLastMinima < 0
    exitSignal := -1//abs(minimaCloseDiff)
    
enterSignal = 0.0
if priceAboveLastMaxima > 0.0 
    enterSignal := 1//max(0, maximaDiff - minimaCloseDiff, maximaCloseDiff) // max(maximaCloseDiff, minimaDiff)
    
// if minimaDiff > 0.0 and priceAboveLastMinima > 0.0
    // enterSignal := 1
    

// plot(minimaDiff, style=plot.style_columns, color = (minimaDiff < 0 ? maximaDeltaColor : minimaDeltaColor))
plot(priceAboveLastMinima, color = negativeColor)
plot(minimaDiff, color = positiveFadedColor)
plot(maximaDiff, color = negativeFadedColor)
plot(priceAboveLastMaxima, color = positiveColor)
plot(exitSignal, style=plot.style_columns, color = negativeColor)
plot(enterSignal, style=plot.style_columns, color = positiveColor)

// plot(array.get(minimaHistory, 1), color = positiveColor)
// plot(minimaDiff, color = minimaDeltaColor)
